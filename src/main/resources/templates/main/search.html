<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>首页，欢迎租车</title>
    <link href="https://www.layuicdn.com/layui-v2.6.2/css/layui.css" rel="stylesheet" type="text/css"/>
</head>
<style>
    .layui-body {
        margin-top: 60px;
        position: initial !important;

    }

    .center-context {
        background: #f2f2f2;
    }

    .call-board > a {
        height: 25px;
        padding-left: 5px;
    }

    .layui-footer {
        left: 0 !important;
        text-align: center;
    }
</style>

<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo">汽车租赁</div>
        <!-- 头部区域（可配合layui 已有的水平导航） -->
        <ul class="layui-nav layui-layout-left">
            <li class="layui-nav-item"><a href="/main">首页</a></li>
            <li class="layui-nav-item"><a th:href="'/main/type?carTypeId=1'">车辆分类</a></li>
            <li class="layui-nav-item layui-this"><a th:href="'/main/search'">车辆搜索</a></li>
            <li class="layui-nav-item"><a th:href="'/main/notice/1'">公告</a></li>
        </ul>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item" th:if="not ${session.customerId}"><a href="/customerLogin" id="login">登录</a></li>
            <li class="layui-nav-item" th:if="${session.customerId}"><img class="layui-nav-img" src="/default.jpg"></li>
            <li class="layui-nav-item" th:if="${session.customerId}"><span
                    th:text="${session.customer.username}"></span></li>
            <li class="layui-nav-item" th:if="${session.customerId}"><a href="/myOrder">我的订单</a></li>
            <li class="layui-nav-item" th:if="${session.customerId}"><a href="/myAssess">我的评价</a></li>
            <li class="layui-nav-item" th:if="${session.customerId}"><a href="/customerInfo">个人中心</a></li>
            <li class="layui-nav-item" th:if="${session.customerId}"><a href="/customer/exit" id="exit">退出</a></li>
        </ul>
    </div>

    <div class="layui-body layui-container center-context" style="padding: 20px">
        <div class="layui-form">
            汽车类型：
            <div class="layui-inline">
                <input autocomplete="off" class="layui-input" name="carType">
            </div>
            车辆型号：
            <div class="layui-inline">
                <input autocomplete="off" class="layui-input" name="brand">
            </div>
            制造商：
            <div class="layui-inline">
                <input autocomplete="off" class="layui-input" name="manufacturer">
            </div>
            车牌号：
            <div class="layui-inline">
                <input autocomplete="off" class="layui-input" name="plateNumber">
            </div>
            最低日租金：
            <div class="layui-inline">
                <input autocomplete="off" class="layui-input" name="moneyMin">
            </div>
            最高日租金：
            <div class="layui-inline">
                <input autocomplete="off" class="layui-input" name="moneyMax">
            </div>
            <button class="layui-btn" lay-filter="search" lay-submit>搜索</button>
        </div>
        <table class="layui-hide" id="car" lay-filter="car"></table>
    </div>
</div>
<script id="leftBtn" type="text/html">
    {{#  if(d.status == '未出租'){ }}
    <a class="layui-btn layui-btn-xs" lay-event="addOrder">下单</a>
    <a class="layui-btn layui-btn-xs" lay-event="showDetail">查看详情</a>
    {{#  } }}
    {{#  if(d.status != '未出租'){ }}
    <a class="layui-btn layui-btn-xs" lay-event="showDetail">查看详情</a>
    {{#  } }}
</script>
<script id="titleTpl" type="text/html">
    <img width="200px" height="100px" src="/oss/download?file={{d.image}}">
</script>
<script src="https://www.layuicdn.com/layui-v2.6.2/layui.js"></script>

<script th:inline="javascript" type="text/javascript">
    layui.use(['table', 'layer', 'form'], function () {
        const table = layui.table;
        const layer = layui.layer;
        const form = layui.form;
        const $ = layui.$;

        // 表单加载
        const tableIns = table.render({
            id: 'car-table',
            elem: '#car',
            url: "/car-info/page",
            contentType: 'application/json',
            method: 'post', //异步请求方法
            toolbar: ['filter'],
            cellMinWidth: 200,
            title: '汽车表',
            cols: [
                [
                    {field: 'id', title: 'id', width: 70,},
                    {field: 'brand', title: '车辆型号', width: 100},
                    {field: 'carTypeName', title: '汽车类型', width: 100,},
                    {field: 'manufacturer', title: '生产厂家', width: 100,},
                    {field: 'plateNumber', title: '车牌', width: 100,},
                    {field: 'money', title: '租金(元/天)', width: 100,},
                    {field: 'cashPledge', title: '押金(元)', width: 100,},
                    {field: 'image', title: '图片', templet: '#titleTpl', width: 150,},
                    {field: 'producedDate', title: '生产日期', width: 120,},
                    {field: 'carColor', title: '汽车颜色', width: 100,},
                    {field: 'status', title: '状态', width: 100,},
                    {field: 'remark', title: '详情'},
                    {fixed: 'right', title: '操作', toolbar: '#leftBtn', width: 200}
                ]],
            page: true,
            request: {
                pageName: 'pageNum', //页码的参数名称，默认：page
                limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            response: {
                statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
            },
            parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                console.log(res);
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.message, //解析提示文本
                    "count": res.map.data.total, //解析数据长度
                    "data": res.map.data.records//解析数据列表
                };
            },
        });

        // 重载
        form.on("submit(search)", data => {
            tableIns.reload({
                url: "/car-info/page",
                contentType: 'application/json',
                method: 'post',
                where: data.field,
                page: {
                    pageNum: 1 // 重新从第 1 页开始
                }
            });
        })

        // 表单右侧行工具栏
        table.on('tool(car)', function (obj) {
            const data = obj.data; //获得当前行数据
            const layEvent = obj.event;
            if (layEvent === 'addOrder') { // 下订单
                layui.use(['layer'], function () {
                    const layer = layui.layer;
                    const $ = layui.$;

                    layer.prompt({title: '请输入要租赁的天数'}, function (value) {
                        const reg = new RegExp('^[1-9]\\d*$');
                        if (!reg.test(value)) {
                            layer.msg('请输入合法的天数(不包括0)。')
                            return
                        }

                        $.ajax({
                            'data': 'carInfoId=' + data.id + "&day=" + value,
                            'url': '/api/order/initOrder',
                            'type': 'post',
                            success: function (data) {
                                if (data.code && data.code === 200) {
                                    layer.msg('订单创建成功，等待工作人员审核。');
                                    setTimeout(() => {
                                        location.reload();
                                    }, 1000)
                                } else {
                                    layer.msg(data.message);
                                }
                            }
                        });
                    });
                });
            } else if (layEvent === 'showDetail') { //编辑
                updateLayer(form, layer, data, upload, $)
            }
        });
    });

    // 添加弹层
    function addLayer(form, layer, upload, $) {

        layer.open({
            title: '添加汽车',
            type: 1,
            skin: 'layui-layer-rim', //加上边框
            area: ['400px', '500px'], //宽高
            offset: 'auto',
            closeBtn: 1,
            content: $("#car-form"),
            success: function (layero) {
                //执行一个laydate实例
                layero.find('#carType option').remove()
                initCartTypeSelect($, layero)
                uploadInit(upload, $, layero)
                layero.find('#update').hide();
                layero.find('#id-item').hide();
                layero.find('#image').hide();
                form.render();
                layui.use('laydate', function () {
                    const laydate = layui.laydate;
                    //常规用法
                    laydate.render({
                        elem: document.getElementById('date'),
                    });
                });

            },
        });
    }

    // 修改弹层
    function updateLayer(form, layer, data, upload, $) {
        layer.open({
            title: '修改汽车',
            type: 1,
            skin: 'layui-layer-rim', //加上边框
            area: ['400px', '500px'], //宽高
            offset: 'auto',
            closeBtn: 1,
            content: $("#car-form"),
            success: function (layero) {
                uploadInit(upload, $, layero)
                layero.find('#insert').hide();
                layero.find('#reset').hide();
                layero.find('#image').hide();
                layero.find('#id').val(data.id);
                layero.find('#money').val(data.money);
                layero.find('#plateNumber').val(data.plateNumber);
                layero.find('#carColor').val(data.carColor);
                layero.find('#brand').val(data.brand);
                layero.find('#manufacturer').val(data.manufacturer);
                layero.find('#cashPledge').val(data.cashPledge);
                layero.find('#remark').val(data.remark);
                layero.find('#demo1').attr('src', "/oss/upload?file=" + data.image)
                layero.find('#carType option').remove()
                initCartTypeSelect($, layero)
                form.render();
                layui.use('laydate', function () {
                    const laydate = layui.laydate;
                    //常规用法
                    laydate.render({
                        elem: document.getElementById('date'),
                    });
                });
            },
        });
    }

    // 上传初始化
    function uploadInit(upload, $, layero) {
        const uploadInst = upload.render({
            elem: '#test1',
            url: '/oss/upload/', //改成您自己的上传接口
            before: function (obj) {
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('.demo1').attr('src', result); //图片链接（base64）
                });
            },
            done: function (res) {
                //如果上传失败
                if (res.code !== 200) {
                    return layer.msg('上传失败');
                } else {
                    layero.find("#image").val(res.data)
                    console.log(res.data)
                    return layer.msg('上传成功')
                }
                //上传成功
            },
            error: function () {
                //演示失败状态，并实现重传
                const demoText = $('.demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function () {
                    uploadInst.upload();
                });
            }
        });
    }

    // 初始化下拉框
    const initCartTypeSelect = function ($, layero) {
        $.ajaxSettings.async = false;
        // 先从后台拿到汽车类型
        $.get('/car-type/list', function (data) {
            layero.find('#carType').append("<option value=''>请选择或搜索汽车类型</option>")
            const typeList = data.map.data;
            for (let i = 0; i < typeList.length; i++) {
                const carType = typeList[i];
                layero.find('#carType').append("<option value=" + carType.id + ">" + carType.name + "</option>")
            }
            console.log('success')
        })
        $.ajaxSettings.async = true;
    }
</script>
<script>
    function goToZL(id) {
        layui.use('layer', function () {
            const layer = layui.layer;
            const $ = layui.$;
            layer.prompt({title: '请输入要租赁的天数'}, function (value, index, elem) {
                const reg = new RegExp('^[1-9]\\d*$');
                if (!reg.test(value)) {
                    layer.msg('请输入合法的天数(不包括0)。')
                    return
                }

                $.ajax({
                    'data': 'carInfoId=' + id + "&day=" + value,
                    'url': '/api/order/initOrder',
                    'type': 'post',
                    success: function (data) {
                        if (data.code && data.code === 200) {
                            layer.msg('订单创建成功，等待工作人员审核。');
                            setTimeout(() => {
                                location.reload();
                            }, 1000)
                        } else {
                            layer.msg(data.message);
                        }
                    }
                });
            });
        });
    }
</script>
</body>
</html>
